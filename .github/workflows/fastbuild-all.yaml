name: fastbuild-all

on:
  workflow_dispatch:

env:
  DK_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DK_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: ${{matrix.title}} ${{matrix.target}}
    runs-on: ubuntu-24.04
    # For `github.event`'s structure, see: https://developer.github.com/v3/activity/events/types/
    # Do not modify the trigger methods here, customize them in the `on` section
    if: |
      github.event_name == 'push'
      || github.event_name == 'repository_dispatch'
      || github.event_name == 'workflow_dispatch'
      || github.event_name == 'deployment'
      || (github.event_name == 'watch' && github.event.action == 'started' && github.event.repository.owner.id == github.event.sender.id)
      || github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        mode:
          - normal
          - test
        # ########### Add your target name below ###########
        # E.g. target: [x86_64, wdr4310v1]
        target: [lumos, lumos-npu, minimal, minimal-npu]
        include:
        - mode: normal
          title: Build
        - mode: test
          title: Fast check
    env:
      HOST_WORK_DIR: ${{github.workspace}}
      BUILD_MODE: ${{matrix.mode}}
      BUILD_TARGET: ${{matrix.target}}

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: 1. Init build env
      run: scripts/cisteps/build-openwrt/01-init_env.sh

    - name: 2. Check if skip this job
      run: scripts/cisteps/build-openwrt/02-check_target.sh

    - name: 3. Clean up for extra space
      if: env.SKIP_TARGET == '0' && env.TEST != '1'
      run: scripts/cisteps/build-openwrt/03-clean_up.sh

    # https://github.com/docker/setup-qemu-action
    - name: Set up QEMU
      id: buildx-qemy
      if: env.SKIP_TARGET == '0'
      uses: docker/setup-qemu-action@v3

    # https://github.com/docker/setup-buildx-action
    - name: Set up Docker Buildx
      id: buildx
      if: env.SKIP_TARGET == '0'
      uses: docker/setup-buildx-action@v3

    - name: 4. Configure docker
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/04-configure_docker.sh

    - name: 5. Check status of builders
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/05-check_builders.sh

    - name: 6. Get builder
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/06-get_builder.sh

    - name: 7. Clone/update OpenWrt
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/07-download_openwrt.sh

    - name: 8. Apply customizations
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/08-customize.sh

    - name: 9. Prepare config file
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/09-prepare_config.sh

    - name: 10. Download packages
      if: env.SKIP_TARGET == '0'
      run: scripts/cisteps/build-openwrt/10-download_packages.sh

    - name: 11. Compile firmware and packages with multiple threads
      id: mtcompile
      if: env.SKIP_TARGET == '0'
      continue-on-error: true
      run: scripts/cisteps/build-openwrt/11-compile_multi.sh

    - name: 12. Compile again more verbosely if failed
      if: env.SKIP_TARGET == '0' && steps.mtcompile.outputs.started == '1' && steps.mtcompile.outputs.status != 'success'
      run: scripts/cisteps/build-openwrt/12-compile_single.sh

    - name: 13. Organize files
      id: organize
      if: env.SKIP_TARGET == '0' && !cancelled()
      run: scripts/cisteps/build-openwrt/13-organize_files.sh

    - name: Create Release
      if: env.SKIP_TARGET == '0' && env.TEST != '1' && env.OPT_PACKAGE_ONLY != '1' && steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        # Extract version code from profiles.json
        version_code=$(jq -r '.version_code' ./openwrt_firmware/profiles.json)
        VERSION="${{matrix.target}}-$(date +'%Y.%m.%d')-${version_code}"
        # Check if the release already exists
        if gh release view "$VERSION" &>/dev/null; then
          gh release delete "$VERSION" --cleanup-tag -y
        fi
        # Create the new release
        FILES_TO_UPLOAD=$(find ./openwrt_firmware -maxdepth 1 -type f -name "*.bin")
        gh release create "$VERSION" $FILES_TO_UPLOAD \
          --title "$VERSION"

    - name: 14. Upload builder
      if: |
        env.SKIP_TARGET == '0' && !cancelled() && (
          job.status == 'success'
          || env.OPT_PUSH_WHEN_FAIL == '1'
        )
      run: scripts/cisteps/build-openwrt/14-upload_builder.sh
